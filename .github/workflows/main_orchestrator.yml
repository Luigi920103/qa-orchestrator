name: QA Orchestrator Central
on:
  # 1. Recibe la se√±al inteligente de la App
  repository_dispatch:
    types: [trigger-automation]

  # 2. Ejecuci√≥n manual desde la UI
  workflow_dispatch:
    inputs:
      service:
        description: '¬øQu√© framework se ejecutar√°?'
        required: true
        default: 'pw_ts_bdd'
        type: choice
        options: [pw_ts_bdd, pw_ts, pw_js_bdd, pw_js, all]
      env:
        description: 'Entorno de destino'
        required: true
        default: 'dev'
        type: choice
        options: [dev, staging, qa, prod]

jobs:
  routing:
    name: Route Execution
    runs-on: ubuntu-latest
    steps:
      - name: üîç Analyzing Trigger
        run: |
          echo "Trigger Source: ${{ github.event_name }}"
          echo "pw_ts_bdd Changed: ${{ github.event.client_payload.pw_ts_bdd_changed }}"
          echo "pw_ts Changed: ${{ github.event.client_payload.pw_ts_changed }}"
          echo "pw_js_bdd Changed: ${{ github.event.client_payload.pw_js_bdd_changed }}"
          echo "pw_js Changed: ${{ github.event.client_payload.pw_js_changed }}"

      # --- 1. PLAYWRIGHT TS BDD ---
      - name: üöÄ Triggering Playwright TS BDD
        if: |
          contains(fromJSON('["pw_ts_bdd", "all"]'), inputs.service) || 
          github.event.client_payload.pw_ts_bdd_changed == 'true'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.ORCHESTRATOR_TOKEN }}
          repository: Luigi920103/pw_ts_bdd
          event-type: run-playwright-docker
          client_payload: '{"env": "${{ github.event.client_payload.env || inputs.env }}"}'

      # --- 2. PLAYWRIGHT TS (SIN BDD) ---
      - name: üöÄ Triggering Playwright TS
        if: |
          contains(fromJSON('["pw_ts", "all"]'), inputs.service) || 
          github.event.client_payload.pw_ts_changed == 'true'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.ORCHESTRATOR_TOKEN }}
          repository: Luigi920103/pw_ts
          event-type: run-playwright-docker
          client_payload: '{"env": "${{ github.event.client_payload.env || inputs.env }}"}'

      # --- 3. API TESTS (OPCIONAL/FUTURO) ---
      - name: üöÄ Triggering API Framework
        if: |
          inputs.service == 'api' || 
          github.event.client_payload.api_changed == 'true'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.ORCHESTRATOR_TOKEN }}
          repository: Luigi920103/repo-api-tests
          event-type: run-api-tests
          client_payload: '{"env": "${{ github.event.client_payload.env || inputs.env }}"}'
