name: QA Orchestrator Central
on:
  # 1. Recibe la se√±al inteligente de la App
  repository_dispatch:
    types: [trigger-automation]

  # 2. Ejecuci√≥n manual desde la UI
  workflow_dispatch:
    inputs:
      service:
        description: '¬øQu√© framework se ejecutar√°?'
        required: true
        default: 'pw_ts_bdd'
        type: choice
        options: [pw_ts_bdd, pw_ts, pw_js_bdd, pw_js, all]
      env:
        description: 'Entorno de destino'
        required: true
        default: 'dev'
        type: choice
        options: [dev, staging, qa, prod]

jobs:
  routing:
    name: Route Execution
    runs-on: ubuntu-latest
    steps:
      - name: üîç Analyzing Trigger
        run: |
          echo "Trigger Source: ${{ github.event_name }}"
          echo "--- Detalle del Payload Recibido ---"
          echo '${{ toJson(github.event.client_payload) }}'
          echo "------------------------------------"
          echo "Analizando carpetas espec√≠ficas:"
          echo "pw_ts_bdd: ${{ github.event.client_payload.pw_ts_bdd_changed }}"
          echo "pw_ts: ${{ github.event.client_payload.pw_ts_changed }}"

      # --- 1. PLAYWRIGHT TS BDD ---
      - name: üöÄ Triggering Playwright TS BDD
        if: |
          (github.event_name == 'workflow_dispatch' && (inputs.service == 'pw_ts_bdd' || inputs.service == 'all')) ||
          (github.event_name == 'repository_dispatch' && github.event.client_payload.pw_ts_bdd_changed == 'true')
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.ORCHESTRATOR_TOKEN }}
          repository: Luigi920103/pw_ts_bdd
          event-type: run-playwright-docker
          client_payload: '{"env": "${{ github.event.client_payload.env || inputs.env || 'dev' }}"}'

      # --- 2. PLAYWRIGHT TS (SIN BDD) ---
      - name: üöÄ Triggering Playwright TS
        if: |
          (github.event_name == 'workflow_dispatch' && (inputs.service == 'pw_ts' || inputs.service == 'all')) ||
          (github.event_name == 'repository_dispatch' && github.event.client_payload.pw_ts_changed == 'true')
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.ORCHESTRATOR_TOKEN }}
          repository: Luigi920103/pw_ts
          event-type: run-playwright-docker
          client_payload: '{"env": "${{ github.event.client_payload.env || inputs.env || 'dev' }}"}'

      # --- 3. OTROS FRAMEWORKS (JS BDD) ---
      - name: üöÄ Triggering Playwright JS BDD
        if: |
          (github.event_name == 'workflow_dispatch' && (inputs.service == 'pw_js_bdd' || inputs.service == 'all')) ||
          (github.event_name == 'repository_dispatch' && github.event.client_payload.pw_js_bdd_changed == 'true')
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.ORCHESTRATOR_TOKEN }}
          repository: Luigi920103/pw_js_bdd
          event-type: run-playwright-docker
          client_payload: '{"env": "${{ github.event.client_payload.env || inputs.env || 'dev' }}"}'
